<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audax Ireland - Cycling Challenge Registration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4b5563">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
        <div id="registration-form" class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">Challenge Registration</h2>
            <form id="challenge-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Select Your Challenge</label>
                    <div class="mt-2 space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="challenge" value="12 x 100km" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">12 x 100km (12-Month Challenge)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="challenge" value="12 x 200km" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">12 x 200km (12-Month Challenge)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="challenge" value="1 x 100km" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">1 x 100km (One-Time Spin)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="challenge" value="1 x 200km" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">1 x 200km (One-Time Spin)</span>
                        </label>
                    </div>
                </div>

                <div id="medal-option" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Medal Option</label>
                    <div class="mt-2 space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="medal" value="Yes" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">I would like to receive a medal.</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="medal" value="No" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">I do not wish to receive a medal.</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="fullName" name="fullName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>

                <div>
                    <label for="clubNumber" class="block text-sm font-medium text-gray-700">Audax Ireland Club Number (Optional)</label>
                    <input type="text" id="clubNumber" name="clubNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>

                <div>
                    <label for="cycleDate" class="block text-sm font-medium text-gray-700">Date of Cycle</label>
                    <input type="date" id="cycleDate" name="cycleDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>

                <div>
                    <label for="startPoint" class="block text-sm font-medium text-gray-700">Starting Point</label>
                    <input type="text" id="startPoint" name="startPoint" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>

                <div>
                    <label for="endPoint" class="block text-sm font-medium text-gray-700">Ending Point</label>
                    <input type="text" id="endPoint" name="endPoint" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>

                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Register & Continue
                </button>
            </form>
        </div>

        <div id="proof-form-section" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">Upload Proof of Completion</h2>
            <p class="text-center text-sm text-gray-600 mb-6">Your registration is complete. Please upload your proof below. All files will be linked to your record.</p>
            <form id="proof-form" class="space-y-6" enctype="multipart/form-data">
                <div>
                    <label for="control1" class="block text-sm font-medium text-gray-700">Control 1 Photo</label>
                    <input type="file" id="control1" name="control1" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300">
                </div>
                <div>
                    <label for="control2" class="block text-sm font-medium text-gray-700">Control 2 Photo</label>
                    <input type="file" id="control2" name="control2" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300">
                </div>
                <div>
                    <label for="control3" class="block text-sm font-medium text-gray-700">Control 3 Photo</label>
                    <input type="file" id="control3" name="control3" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300">
                </div>
                <div>
                    <label for="control4" class="block text-sm font-medium text-gray-700">Control 4 Photo</label>
                    <input type="file" id="control4" name="control4" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300">
                </div>
                <div>
                    <label for="gpxFile" class="block text-sm font-medium text-gray-700">GPX File</label>
                    <input type="file" id="gpxFile" name="gpxFile" accept=".gpx" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300">
                </div>
                <div>
                    <label for="stravaLink" class="block text-sm font-medium text-gray-700">Strava Link</label>
                    <input type="url" id="stravaLink" name="stravaLink" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>

                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Submit Proof
                </button>
            </form>
        </div>

        <div id="success-message" class="hidden text-center text-green-700 font-bold mt-4">
            Thank you! Your submission has been received.
        </div>
        <div id="error-message" class="hidden text-center text-red-700 font-bold mt-4">
            An error occurred. Please try again.
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js', { scope: '/' })
                .then(registration => console.log('Service Worker Registered'))
                .catch(error => console.log('Service Worker Registration Failed:', error));
            }
        });

        const SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'; // *** IMPORTANT: PASTE YOUR DEPLOYED URL HERE ***
        const challengeForm = document.getElementById('challenge-form');
        const proofForm = document.getElementById('proof-form');
        const registrationSection = document.getElementById('registration-form');
        const proofSection = document.getElementById('proof-form-section');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const medalOption = document.getElementById('medal-option');
        let recordId = '';

        document.querySelectorAll('input[name="challenge"]').forEach(radio => {
            radio.addEventListener('change', (event) => {
                const value = event.target.value;
                if (value.includes('One-Time Spin')) {
                    medalOption.classList.remove('hidden');
                } else {
                    medalOption.classList.add('hidden');
                }
            });
        });

        challengeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(challengeForm);
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    recordId = data.recordId;
                    registrationSection.classList.add('hidden');
                    proofSection.classList.remove('hidden');
                } else {
                    errorMessage.textContent = 'Registration failed. ' + data.message;
                    errorMessage.classList.remove('hidden');
                }
            })
            .catch(error => {
                errorMessage.textContent = 'Error: Could not connect to the server.';
                errorMessage.classList.remove('hidden');
                console.error('Error:', error);
            });
        });

        proofForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(proofForm);
            formData.append('recordId', recordId); // Attach the unique ID from the first submission
            formData.append('type', 'proof'); // Tell the script this is a proof upload

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    proofSection.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                } else {
                    errorMessage.textContent = 'Proof upload failed. ' + data.message;
                    errorMessage.classList.remove('hidden');
                }
            })
            .catch(error => {
                errorMessage.textContent = 'Error: Could not upload proof.';
                errorMessage.classList.remove('hidden');
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>
